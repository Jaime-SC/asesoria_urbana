{% load static %}
<link rel="stylesheet" href="{% static 'css/egresos_au/egresos_au.css' %}" />
<link rel="stylesheet" href="{% static 'css/egresos_au/egresos_auMediaQuery.css' %}" />


<div style="display: flex; justify-content: space-between;">
  <div class="egresos-toolbar" style="display: flex;gap: 1rem;align-items: stretch;">
    <div class="searchContainerEgresosAU">
      <span class="material-symbols-outlined">search</span>
      <input id="searchEgresosAU" type="text" placeholder="Buscar Egresos AU..." class="search-input-egresosAU" />
    </div>
    <!-- ANCLA RELATIVA PARA EL POPOVER -->
    <div class="filters-popover-anchor">
      <button id="btnToggleFiltersEgresosAU" class="buttonLogin" aria-expanded="false" aria-controls="filterPanelEgresosAU">
        <span class="material-symbols-outlined">manage_search</span>
        <span>Filtros</span>
      </button>
      {% include 'bnup/egresos_au/egresos_au_filters_panel.html' %}
    </div>
  </div>
  <div id="paginationEgresosAU" class="pagination"></div>
</div>

<table id="tablaEgresosAU">
  <thead>
    <tr>
      {% if tipo_usuario == 'ADMIN' or tipo_usuario == 'SECRETARIA' %}
        <th class="non-clickable">
          <input type="checkbox" id="checkAllEgresos" class="select-all" />
        </th>
      {% endif %}
      <th data-type="number">NÂº Egreso</th>
      <th data-type="date">Fecha</th>
      <th>Funcionario</th>
      <th>Destinatario</th>
      <th>DescripciÃ³n</th>
      <th>Adjunto</th>
      <th>Respuesta</th>
    </tr>
  </thead>
  <tbody>
    {% for e in egresos %}
      <tr data-id="{{ e.id }}"
        data-numero="{{ e.numero_egreso }}"
        data-fecha="{{ e.fecha_egreso }}"
        data-funcionario="{% for f in e.funcionarios.all %}
          {{ f.nombre }}{% if not forloop.last %}, {% endif %}
        {% endfor %}"
        data-destinatario="{{ e.destinatario.nombre }}"
        data-descripcion="{{ e.descripcion|default:''|escapejs }}">
        {% if tipo_usuario == 'ADMIN' or tipo_usuario == 'SECRETARIA' %}
          <td class="celda-checkbox">
            <div>
              <input type="checkbox" class="rowCheckbox" data-id="{{ e.id }}" />
            </div>
          </td>
        {% endif %}
        <td class="celda-numEgreso" data-order="{{ e.numero_egreso }}">
          <div>{{ e.numero_egreso }}</div>
        </td>

        <td class="celda-fecha" data-order="{{ e.fecha_egreso|date:'Ymd' }}">
          <div>{{ e.fecha_egreso|date:'d/m/Y' }}</div>
        </td>
        <td>
          {% for f in e.funcionarios.all %}
            {{ f.nombre }}{% if not forloop.last %}, {% endif %}
          {% empty %}
            â€”
          {% endfor %}
        </td>
        <td>{{ e.destinatario.nombre }}</td>
        <td class="descripcion-cell">
          <div>
            <span class="span-descripcion-cell" style="cursor:pointer;">
              {{ e.descripcion|default:'â€”'|truncatechars:60 }}
              {% if e.descripcion|length > 60 %} {% endif %}
            </span>
            <div class="icon-container">
              <span class="material-symbols-outlined preview-btn">preview</span>
            </div>
          </div>
        </td>
        <td class="celda-adjunto">
          <div>
            {% if e.archivo_adjunto %}
              <div class="icon-container">
                <a href="{{ e.archivo_adjunto.url }}" target="_blank" style="text-decoration: none;"><button class="buttonLogin buttonPreview"><span class="material-symbols-outlined bell">find_in_page</span></button></a>
                <div class="tooltip">Ver adjunto</div>
              </div>
            {% else %}
              â€”
            {% endif %}
          </div>
        </td>
        <td class="celda-respuesta">
          <div class="icon-container">
            {% if e.archivo_respuesta %}
              {# âœ… todos pueden ver la respuesta si existe #}
              <a href="{{ e.archivo_respuesta.url }}" target="_blank" style="text-decoration: none;"><button class="buttonLogin buttonPreview btn-view-respuesta"><span class="material-symbols-outlined bell">find_in_page</span></button></a>
              <div class="tooltip">Ver respuesta</div>
            {% else %}
              {% if tipo_usuario == 'ADMIN' or tipo_usuario == 'SECRETARIA' %}
                {# âœ… solo ADMIN/SECRETARIA pueden subir #}
                <button class="buttonLogin buttonPreview btn-add-respuesta" data-id="{{ e.id }}"><span class="material-symbols-outlined bell">note_add</span></button>
                <div class="tooltip">Subir respuesta</div>
              {% else %}
                {# ðŸš« resto la ve deshabilitada #}
                <button class="buttonLogin buttonPreview" disabled style="opacity:.6;cursor:not-allowed;"><span class="material-symbols-outlined bell">note_add</span></button>
                <div class="tooltip">Sin permiso para subir</div>
              {% endif %}
            {% endif %}
          </div>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="{% if tipo_usuario == 'ADMIN' or tipo_usuario == 'SECRETARIA' %}
            8
          {% else %}
            7
          {% endif %}">No hay egresos registrados.</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

{% include 'bnup/egresos_au/preview_modal.html' %}

<!-- NO lo tengas aquÃ­ dentro: -->
<div id="egresoModalOverlay" class="modal-overlay" style="display:none;">
  <div class="modal-content"></div>
</div>

<div id="egresoEditModalOverlay" class="modal-overlay" style="display:none;">
  <div class="modal-content"></div>
</div>

<div id="egresoRespuestaModalOverlay" class="modal-overlay" style="display:none;">
  <div class="modal-content"></div>
</div>
