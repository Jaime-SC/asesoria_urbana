{% load static %}
<link rel="stylesheet" href="{% static 'css/egresos_au.css' %}" />

<div id="egresosAUTable">
  <div style="display: flex; justify-content: space-between;">
    <div class="egresos-toolbar" style="display: flex;gap: 1rem;align-items: stretch;">
      <div class="searchContainerEgresosAU">
        <span class="material-symbols-outlined">search</span>
        <input id="searchEgresosAU" type="text" placeholder="Buscar Egresos AU..." class="search-input-egresosAU">
      </div>
      <!-- ANCLA RELATIVA PARA EL POPOVER -->
      <div class="filters-popover-anchor">
        <button id="btnToggleFiltersEgresosAU" class="buttonLogin" aria-expanded="false" aria-controls="filterPanelEgresosAU">
          <span class="material-symbols-outlined">manage_search</span>
          <p>Filtros</p>
        </button>

        {# el panel va aquí, pegado al botón #}
        {% include 'bnup/egresos_au/egresos_au_filters_panel.html' %}
      </div>
    </div>
    <div id="paginationEgresosAU" class="pagination"></div>
  </div>

  </div>
  <table id="tablaEgresosAU">
    <thead>
      <tr>
        <th class="non-clickable">
          <input type="checkbox" id="checkAllEgresos" class="select-all" />
        </th>
        <th data-type="number">Nº Egreso</th>
        <th data-type="date">Fecha</th>
        <th>Funcionario</th>
        <th>Destinatario</th>
        <th>Descripción</th>
        <th>Adjunto</th>
        <th>Respuesta</th>

      </tr>
    </thead>
    <tbody>
      {% for e in egresos %}
        <tr
          data-id="{{ e.id }}"
          data-numero="{{ e.numero_egreso }}"
          data-fecha="{{ e.fecha_egreso }}"
          data-funcionario="{% for f in e.funcionarios.all %}{{ f.nombre }}{% if not forloop.last %}, {% endif %}{% endfor %}"
          data-destinatario="{{ e.destinatario.nombre }}"
          data-descripcion="{{ e.descripcion|default:''|escapejs }}"
        > 
          <td class="celda-checkbox">
            <div>
              <input type="checkbox" class="rowCheckbox" data-id="{{ e.id }}" />
            </div>
          </td>
          <td class="celda-numEgreso" data-order="{{ e.numero_egreso }}">
            <div>{{ e.numero_egreso }}</div>
          </td>

          <td class="celda-fecha" data-order="{{ e.fecha_egreso|date:'Ymd' }}">
            <div>{{ e.fecha_egreso|date:'d/m/Y' }}</div>
          </td>
          <td>
            {% for f in e.funcionarios.all %}
              {{ f.nombre }}{% if not forloop.last %}, {% endif %}
            {% empty %}
              —
            {% endfor %}
          </td>
          <td>{{ e.destinatario.nombre }}</td>
          <td class="descripcion-cell">
            <div>
              <span class="span-descripcion-cell" style="cursor:pointer;">
                {{ e.descripcion|default:"—"|truncatechars:60 }}
                {% if e.descripcion|length > 60 %} {% endif %}
              </span>
              <span class="material-symbols-outlined preview-btn">preview</span>
            </div>
          </td>
          <td class="celda-adjunto">
            <div>
              {% if e.archivo_adjunto %}
                <div class="icon-container">
                  <a href="{{ e.archivo_adjunto.url }}" target="_blank" style="text-decoration: none;">
                    <button class="buttonLogin buttonPreview">
                      <span class="material-symbols-outlined bell">find_in_page</span>
                    </button>
                  </a>
                  <div class="tooltip">Ver adjunto</div>
                </div>
              {% else %}
                —
              {% endif %}
            </div>
          </td>
          <td class="celda-respuesta">
            <div>
              {% if e.archivo_respuesta %}
                <div class="icon-container">
                  <a href="{{ e.archivo_respuesta.url }}" target="_blank" style="text-decoration: none;">
                    <button class="buttonLogin buttonPreview btn-view-respuesta">
                      <span class="material-symbols-outlined bell">find_in_page</span>
                    </button>
                  </a>
                  <div class="tooltip">Ver respuesta</div>
                </div>
              {% else %}
                <div class="icon-container">
                  <button class="buttonLogin buttonPreview btn-add-respuesta" data-id="{{ e.id }}">
                    <span class="material-symbols-outlined bell">note_add</span>
                  </button>
                  <div class="tooltip">Subir respuesta</div>
                </div>
              {% endif %}
            </div>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="6">No hay egresos registrados.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>  
  
</div>
{% include 'bnup/egresos_au/preview_modal.html' %}

<!-- NO lo tengas aquí dentro: -->
  <div id="egresoModalOverlay" class="modal-overlay" style="display:none;">
    <div class="modal-content"></div>
  </div>

  <div id="egresoEditModalOverlay" class="modal-overlay" style="display:none;">
    <div class="modal-content"></div>
  </div>

  <div id="egresoRespuestaModalOverlay" class="modal-overlay" style="display:none;">
    <div class="modal-content"></div>
  </div>


